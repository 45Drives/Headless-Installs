#version=RHEL9
cmdline

# 1. This tells the installer to look for the file we're about to build
%include /tmp/disk-config

# --- GLOBAL SETTINGS (Stay outside the include) ---
lang en_US.UTF-8
keyboard us
timezone America/New_York --utc
rootpw --iscrypted $6$pAzKGjUDjrB.xYXL$AtpXHI/jZlKkSHzK0gohKcSB6VtUzGRGQ9r.y2PMVyC3rmPddjDtO3juTVuhx6awd/62Q93rRmFqAnabUtgTp0
firstboot --enable

# --- REPOS ---
url --url="https://dl.rockylinux.org/pub/rocky/9/BaseOS/x86_64/os/"
repo --name="AppStream" --baseurl="https://dl.rockylinux.org/pub/rocky/9/AppStream/x86_64/os/"
repo --name="CRB" --baseurl="https://dl.rockylinux.org/pub/rocky/9/CRB/x86_64/os/"
repo --name="extras" --baseurl="https://dl.rockylinux.org/pub/rocky/9/extras/x86_64/os/"

# --- PRE-INSTALL SCRIPT ---
%pre --interpreter=/bin/bash
# Identify truly unique physical ATA ports
UNIQUE_ATA=$(ls -1 /dev/disk/by-path/pci-*-ata-* | grep -v "part" | sed 's/\.[0-9]$//' | sort -u | head -n 2)

D1=$(echo "$UNIQUE_ATA" | sed -n '1p')
D2=$(echo "$UNIQUE_ATA" | sed -n '2p')

# Now we write all the dynamic stuff to the include file
cat <<EOF > /tmp/disk-config
network --bootproto=dhcp --onboot=yes --activate --hostname=cephnode

ignoredisk --only-use=$D1,$D2
clearpart --all --initlabel --drives=$D1,$D2

part raid.boot1 --fstype="mdmember" --ondisk=$D1 --size=954
part raid.boot2 --fstype="mdmember" --ondisk=$D2 --size=954
part raid.swap1 --fstype="mdmember" --ondisk=$D1 --size=3053
part raid.swap2 --fstype="mdmember" --ondisk=$D2 --size=3053
part raid.root1 --fstype="mdmember" --ondisk=$D1 --size=26528 --grow
part raid.root2 --fstype="mdmember" --ondisk=$D2 --size=26528 --grow
part biosboot --size=1 --ondisk=$D1
part biosboot --size=1 --ondisk=$D2

raid /boot --device=boot --fstype="xfs" --level=RAID1 raid.boot1 raid.boot2
raid /     --device=root --fstype="xfs" --level=RAID1 raid.root1 raid.root2
raid swap  --device=swap --fstype="swap" --level=RAID1 raid.swap1 raid.swap2

bootloader --location=mbr --driveorder=$D1,$D2 --append="crashkernel=auto"
EOF
# THIS EOF ABOVE CLOSES THE FILE. 
%end
# THIS %END ABOVE CLOSES THE %PRE SECTION.

# --- PACKAGES ---
%packages
@^minimal-environment
%end

firstboot --enable

# Post-install: optional custom commands
%post --log=/root/kickstart-post.log --interpreter=/bin/bash
cat >/etc/yum.repos.d/45drives-enterprise.repo <<EOF
[45drives_enterprise]
enabled = 1
priority = 1
gpgcheck = 1
repo_gpgcheck = 1
baseurl = https://repo.45drives.com/enterprise/rocky/el9/stable
gpgkey = https://repo.45drives.com/key/gpg.asc
name = 45Drives Enterprise $releasever Repo

[45drives_enterprise_testing]
enabled = 0
priority = 1
gpgcheck = 1
repo_gpgcheck = 1
baseurl = https://repo.45drives.com/enterprise/rocky/el9/testing
gpgkey = https://repo.45drives.com/key/gpg.asc
name = 45Drives Enterprise $releasever Testing Repo
EOF

cat >/etc/yum.repos.d/ceph-stable.repo <<EOF
[ceph_stable]
baseurl = http://download.ceph.com/rpm-squid/el9/x86_64
gpgcheck = 1
gpgkey = https://download.ceph.com/keys/release.asc
name = Ceph Stable \$basearch repo
priority = 2

[ceph_stable_noarch]
baseurl = http://download.ceph.com/rpm-squid/el9/noarch
gpgcheck = 1
gpgkey = https://download.ceph.com/keys/release.asc
name = Ceph Stable noarch repo
priority = 2
EOF

dnf install -y epel-release
dnf install -y 45drives-tools
setenforce 0
sed -i 's/^\(SELINUX=\).*$/\1permissive/' /etc/selinux/config
dnf -y install dnf-plugins-core
crb enable
dnf install -y cephadm podman cockpit cockpit-bridge cockpit-benchmark cockpit-navigator cockpit-file-sharing cockpit-45drives-hardware cockpit-identities cockpit-storaged cockpit-scheduler nano tuned
firewall-cmd --add-service=cockpit --permanent
firewall-cmd --reload
systemctl enable --now cockpit.socket
sed -i 's/^#*PermitRootLogin.*/PermitRootLogin yes/' /etc/ssh/sshd_config
dnf update -y --nobest

%end
